name: Archive Creation on PR

on:
  pull_request:
    types: [opened]
    branches: [main]

jobs:
  create-archive:
    # github-actions[bot]ãŒä½œæˆã—ãŸPRã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.user.login == 'github-actions[bot]'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆã«ã¯å±¥æ­´ãŒå¿…è¦
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Generate work archive
      run: |
        echo "ğŸ“š ä½œæ¥­ã‚µãƒãƒªãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã„ã¾ã™..."
        npm run archive:create
        
    - name: Check if archive was created
      id: check_archive
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "archive_created=true" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
        else
          echo "archive_created=false" >> $GITHUB_OUTPUT
          echo "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
        fi
        
    - name: Commit and push archive
      if: steps.check_archive.outputs.archive_created == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ä½œæˆã•ã‚ŒãŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        ARCHIVE_FILE=$(git status --porcelain | grep "docs/archives/" | head -1 | awk '{print $2}')
        
        if [ -n "$ARCHIVE_FILE" ]; then
          git add "$ARCHIVE_FILE"
          git commit -m "docs: ä½œæ¥­ã‚µãƒãƒªãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆ [archive-auto]
          
          ğŸ¤– GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆ
          ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: $ARCHIVE_FILE
          ğŸ¯ å¯¾è±¡PR: #${{ github.event.number }}
          â° ç”Ÿæˆæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
          
          git push origin ${{ github.head_ref }}
          
          echo "âœ… ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ: $ARCHIVE_FILE"
        fi
        
    - name: Add archive comment to PR
      if: steps.check_archive.outputs.archive_created == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // æœ€æ–°ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          const archivesDir = path.join(process.cwd(), 'docs', 'archives');
          const files = fs.readdirSync(archivesDir)
            .filter(file => file.endsWith('.md') && file !== 'TEMPLATE.md')
            .map(file => ({
              name: file,
              path: path.join(archivesDir, file),
              mtime: fs.statSync(path.join(archivesDir, file)).mtime
            }))
            .sort((a, b) => b.mtime - a.mtime);
            
          if (files.length > 0) {
            const latestArchive = files[0];
            
            const comment = `## ğŸ“š ä½œæ¥­ã‚µãƒãƒªãƒ¼ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
            
ğŸ¯ **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«**: [\`docs/archives/${latestArchive.name}\`](https://github.com/${{ github.repository }}/blob/${{ github.head_ref }}/docs/archives/${latestArchive.name})

ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæ¥­å†…å®¹ãŒè‡ªå‹•çš„ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚

### ğŸ“‹ å«ã¾ã‚Œã‚‹æƒ…å ±
- å®Ÿè£…ã—ãŸæ©Ÿèƒ½ãƒ»ä¿®æ­£å†…å®¹
- å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
- ä½¿ç”¨ã—ãŸé–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
- Gitæ“ä½œè¨˜éŒ²
- æŠ€è¡“çš„æˆæœã¨å­¦ç¿’äº‹é …

---
ğŸ¤– *GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆ*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
          
    - name: Archive creation summary
      run: |
        echo "ğŸ‰ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†"
        echo "ğŸ“Š å®Ÿè¡Œçµæœ:"
        echo "  - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ: ${{ steps.check_archive.outputs.archive_created }}"
        echo "  - å¯¾è±¡PR: #${{ github.event.number }}"
        echo "  - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.head_ref }}"