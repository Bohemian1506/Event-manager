name: Claude Code Issue Enhancement - EventPay Manager

on:
  issues:
    types: [labeled]

jobs:
  enhance-issue:
    # 'needs-details' ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸Žã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event.label.name == 'needs-details' &&
      github.event.action == 'labeled'
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Enhance Issue with Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Create Node.js script for Claude API call
          cat > enhance_issue.js << 'EOF'
          const https = require('https');
          const { execSync } = require('child_process');
          
          const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;
          const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
          const ISSUE_NUMBER = process.env.ISSUE_NUMBER;
          const ISSUE_TITLE = process.env.ISSUE_TITLE;
          const ISSUE_BODY = process.env.ISSUE_BODY;
          
          // Claude API request payload
          const requestData = JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 4000,
            temperature: 0.3,
            messages: [{
              role: "user",
              content: `ã‚ãªãŸã¯ EventPay Manager ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Issueè©³ç´°åŒ–ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
          ä»¥ä¸‹ã®Issueã‚’é–‹ç™ºã«å¿…è¦ãªè©³ç´°æƒ…å ±ã‚’å«ã‚€å®Œå…¨ãªIssueæœ¬æ–‡ã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
          
          ã€å…ƒã®Issueæƒ…å ±ã€‘
          ã‚¿ã‚¤ãƒˆãƒ«: ${ISSUE_TITLE}
          å†…å®¹: ${ISSUE_BODY}
          
          ã€æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã€‘
          - Ruby 3.3.6 + Rails 8.0.0
          - PostgreSQL 15
          - Bootstrap 5 + Stimulus
          - Dockerç’°å¢ƒ
          - ViewComponent
          - SendGrid (ãƒ¡ãƒ¼ãƒ«)
          
          ã€è©³ç´°åŒ–è¦ä»¶ã€‘
          ä»¥ä¸‹ã®æ§‹é€ ã§è©³ç´°ãªIssueæœ¬æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          ## ðŸ“‹ æ¦‚è¦
          [å…ƒã®èª¬æ˜Žã‚’åŸºã«ã€ã‚ˆã‚Šè©³ç´°ãªèª¬æ˜Žã‚’è¨˜è¼‰]
          
          ## ðŸŽ¯ ç›®çš„ãƒ»èƒŒæ™¯  
          [ã“ã®æ©Ÿèƒ½/ä¿®æ­£ãŒå¿…è¦ãªç†ç”±ã¨æœŸå¾…ã•ã‚Œã‚‹ä¾¡å€¤]
          
          ## ðŸ“ æŠ€è¡“çš„è©³ç´°
          
          ### å®Ÿè£…æ–¹é‡
          [æŠ€è¡“çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨è¨­è¨ˆåˆ¤æ–­]
          
          ### ä½¿ç”¨æŠ€è¡“
          - [é–¢é€£ã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¨ç†ç”±]
          
          ### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´
          - [å¿…è¦ãªãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚¹ã‚­ãƒ¼ãƒžå¤‰æ›´]
          
          ## ðŸ“ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—
          1. [ ] [å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—1]
          2. [ ] [å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—2]
          3. [ ] [å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—3]
          
          ## âœ… å—ã‘å…¥ã‚ŒåŸºæº–
          - [ ] [æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã¨è¨€ãˆã‚‹å…·ä½“çš„ãªæ¡ä»¶1]
          - [ ] [æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã¨è¨€ãˆã‚‹å…·ä½“çš„ãªæ¡ä»¶2]
          - [ ] [æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã¨è¨€ãˆã‚‹å…·ä½“çš„ãªæ¡ä»¶3]
          
          ## ðŸ” è€ƒæ…®äº‹é …
          
          ### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - [èªè¨¼ãƒ»èªå¯ãƒ»ãƒ‡ãƒ¼ã‚¿ä¿è­·ã«é–¢ã™ã‚‹è€ƒæ…®ç‚¹]
          
          ### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹
          - [å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚„è² è·ã«é–¢ã™ã‚‹è€ƒæ…®ç‚¹]
          
          ### UI/UX
          - [ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹è€ƒæ…®ç‚¹]
          
          ## ðŸ”— é–¢é€£æƒ…å ±
          - é–¢é€£Issue: #[ç•ªå·ãŒã‚ã‚Œã°]
          - é–¢é€£PR: #[ç•ªå·ãŒã‚ã‚Œã°]
          - å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: [ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã°]
          
          ## ðŸ“Š æŽ¨å¥¨è¨­å®š
          - **Phase**: phase-[2/3/4]
          - **ã‚«ãƒ†ã‚´ãƒª**: [auth/ui/api/payment/notificationç­‰]
          - **å„ªå…ˆåº¦**: priority-[high/medium/low]  
          - **è¦‹ç©ã‚‚ã‚Š**: [S/M/L/XL]
          
          ---
          ðŸ¤– ã“ã®Issueã¯ Claude Code ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«è©³ç´°åŒ–ã•ã‚Œã¾ã—ãŸ
          
          ã€æ³¨æ„äº‹é …ã€‘
          - EventPay Managerã¯åˆå­¦è€…å‘ã‘ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€æŠ€è¡“çš„èª¬æ˜Žã¯åˆ†ã‹ã‚Šã‚„ã™ã
          - Rails 8.0ã®æ–°æ©Ÿèƒ½ï¼ˆæ¨™æº–èªè¨¼ã€Solid Queueç­‰ï¼‰ã®æ´»ç”¨ã‚’è€ƒæ…®
          - Dockerç’°å¢ƒã§ã®å‹•ä½œã‚’å‰æã¨ã—ãŸå®Ÿè£…æ–¹é‡
          - æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¨ã®æ•´åˆæ€§ã‚’é‡è¦–
          
          ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã§ã€å…ƒã®Issueå†…å®¹ã‚’è©³ç´°åŒ–ã—ãŸå®Œå…¨ãªmarkdownæœ¬æ–‡ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`
            }]
          });
          
          // Claude API options
          const options = {
            hostname: 'api.anthropic.com',
            port: 443,
            path: '/v1/messages',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01',
              'Content-Length': Buffer.byteLength(requestData)
            }
          };
          
          // Make API request to Claude
          const req = https.request(options, (res) => {
            let data = '';
            
            res.on('data', (chunk) => {
              data += chunk;
            });
            
            res.on('end', () => {
              try {
                const response = JSON.parse(data);
                
                if (response.content && response.content[0] && response.content[0].text) {
                  const enhancedBody = response.content[0].text;
                  
                  // Update GitHub Issue using gh CLI
                  const escapedBody = enhancedBody.replace(/"/g, '\\"').replace(/`/g, '\\`');
                  const updateCommand = `gh issue edit ${ISSUE_NUMBER} --body "${escapedBody}"`;
                  
                  try {
                    execSync(updateCommand, { 
                      env: { ...process.env, GITHUB_TOKEN },
                      stdio: 'inherit'
                    });
                    console.log(`âœ… Issue #${ISSUE_NUMBER} has been enhanced successfully!`);
                    
                    // Add success comment
                    const commentCommand = `gh issue comment ${ISSUE_NUMBER} --body "ðŸ¤– Issueè©³ç´°åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼\\n\\nè‡ªå‹•çš„ã«ä»¥ä¸‹ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼š\\n- æŠ€è¡“çš„è©³ç´°ã¨å®Ÿè£…æ–¹é‡\\n- æ®µéšŽçš„ãªå®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—\\n- ãƒ†ã‚¹ãƒˆå¯èƒ½ãªå—ã‘å…¥ã‚ŒåŸºæº–\\n- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è€ƒæ…®äº‹é …\\n- æŽ¨å¥¨ãƒ©ãƒ™ãƒ«ã¨å„ªå…ˆåº¦"`;
                    execSync(commentCommand, { 
                      env: { ...process.env, GITHUB_TOKEN },
                      stdio: 'inherit'
                    });
                    
                  } catch (error) {
                    console.error('Failed to update issue:', error.message);
                    process.exit(1);
                  }
                } else {
                  console.error('Invalid response from Claude API:', response);
                  process.exit(1);
                }
              } catch (error) {
                console.error('Failed to parse Claude API response:', error.message);
                console.error('Response data:', data);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (error) => {
            console.error('Claude API request failed:', error.message);
            process.exit(1);
          });
          
          req.write(requestData);
          req.end();
          EOF
          
          # Execute the Node.js script
          node enhance_issue.js