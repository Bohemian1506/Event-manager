name: Auto PR Creation

on:
  push:
    branches-ignore:
      - main
      - master

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-pr]')
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check if PR already exists
        id: check-pr
        run: |
          EXISTING_PR=$(gh pr list --head "${{ github.ref_name }}" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰PRã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
          if [[ $BRANCH_NAME =~ ^feature/.* ]]; then
            PR_TITLE="feat: ${BRANCH_NAME#feature/}"
          elif [[ $BRANCH_NAME =~ ^fix/.* ]]; then
            PR_TITLE="fix: ${BRANCH_NAME#fix/}"
          elif [[ $BRANCH_NAME =~ ^refactor/.* ]]; then
            PR_TITLE="refactor: ${BRANCH_NAME#refactor/}"
          else
            PR_TITLE="$COMMIT_MSG"
          fi
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main..HEAD | head -10)
          FILE_COUNT=$(git diff --name-only origin/main..HEAD | wc -l)
          
          # PRæœ¬æ–‡ã‚’å‹•çš„ç”Ÿæˆ
          PR_BODY="## ğŸ“ å¤‰æ›´æ¦‚è¦
          
          **ãƒ–ãƒ©ãƒ³ãƒ**: \`$BRANCH_NAME\`
          **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: $COMMIT_MSG
          
          ## ğŸ“‹ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ« ($FILE_COUNTä»¶)
          
          \`\`\`
          $CHANGED_FILES
          \`\`\`
          $(if [ $FILE_COUNT -gt 10 ]; then echo "...ä»– $((FILE_COUNT - 10)) ãƒ•ã‚¡ã‚¤ãƒ«"; fi)
          
          ## ğŸ¤– Claude Codeé€£æº
          
          ã“ã® PR ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚„æœ¬æ–‡ã®æ”¹å–„ã«ã¯ä»¥ä¸‹ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼š
          
          - **@claude** ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ PR ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
          - **Claude Code** ã§ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚„æ”¹å–„ææ¡ˆã‚’å®Ÿè¡Œ
          - **zen-mcp-server** ã§è¤‡æ•° AI ã«ã‚ˆã‚‹åŒ…æ‹¬çš„ãªåˆ†æ
          
          ## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          
          - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿæ–½
          - [ ] ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ»ç¢ºèª
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          
          ---
          *ã“ã®PRã¯ [EventPay Manager è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ](docs/workflows/claude-code-workflow.md) ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
          
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --head "${{ github.ref_name }}" \
            --base main
            
          echo "âœ… ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸ: $PR_TITLE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update existing PR
        if: steps.check-pr.outputs.pr_exists == 'true'
        run: |
          echo "âœ… ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${{ steps.check-pr.outputs.pr_number }} ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}