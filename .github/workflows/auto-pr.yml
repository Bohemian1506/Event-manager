name: Auto PR Creation

on:
  push:
    branches-ignore:
      - main
      - master

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-pr]')
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check if PR already exists
        id: check-pr
        run: |
          EXISTING_PR=$(gh pr list --head "${{ github.ref_name }}" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          # ブランチ名からPRタイトルを生成
          if [[ $BRANCH_NAME =~ ^feature/.* ]]; then
            PR_TITLE="feat: ${BRANCH_NAME#feature/}"
          elif [[ $BRANCH_NAME =~ ^fix/.* ]]; then
            PR_TITLE="fix: ${BRANCH_NAME#fix/}"
          elif [[ $BRANCH_NAME =~ ^refactor/.* ]]; then
            PR_TITLE="refactor: ${BRANCH_NAME#refactor/}"
          else
            PR_TITLE="$COMMIT_MSG"
          fi
          
          # PRボディを生成
          cat > pr_body.md << 'EOF'
          ## 概要
          自動生成されたプルリクエストです。
          
          ## 変更内容
          - [ ] 実装した機能/修正した項目
          - [ ] テストケース追加
          - [ ] ドキュメント更新
          
          ## テスト
          - [ ] 単体テスト実行
          - [ ] 統合テスト実行  
          - [ ] 手動テスト完了
          - [ ] RSpec・テストスイート全体実行
          
          ## チェックリスト
          - [ ] RuboCop警告なし
          - [ ] テストが通る
          - [ ] 機能が正常に動作する
          - [ ] セキュリティ要件確認
          - [ ] パフォーマンス影響確認
          - [ ] ドキュメントを更新（必要に応じて）
          
          ## 関連情報
          - Branch: `${{ github.ref_name }}`
          - Latest Commit: `${{ github.event.head_commit.id }}`
          
          🤖 このPRは自動生成されました。必要に応じて内容を更新してください。
          EOF
          
          gh pr create \
            --title "$PR_TITLE" \
            --body-file pr_body.md \
            --head "${{ github.ref_name }}" \
            --base main \
            --draft
            
          echo "✅ プルリクエストを自動作成しました: $PR_TITLE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update existing PR
        if: steps.check-pr.outputs.pr_exists == 'true'
        run: |
          echo "✅ プルリクエスト #${{ steps.check-pr.outputs.pr_number }} が既に存在するため、新しいコミットが追加されました"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}